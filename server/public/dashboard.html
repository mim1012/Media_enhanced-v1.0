<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>📱 Media Enhanced 관리자</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        
        .header { background: #2196F3; color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .header h1 { margin-bottom: 10px; }
        .stats { display: flex; gap: 20px; margin-bottom: 20px; }
        .stat-card { background: white; padding: 20px; border-radius: 8px; flex: 1; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .stat-number { font-size: 2em; font-weight: bold; color: #2196F3; }
        
        .section { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input, .form-group select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; }
        
        .btn { padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .btn-primary { background: #2196F3; color: white; }
        .btn-success { background: #4CAF50; color: white; }
        .btn-danger { background: #f44336; color: white; }
        .btn:hover { opacity: 0.9; }
        
        .user-list { margin-top: 20px; }
        .user-item { background: #f9f9f9; padding: 15px; margin: 10px 0; border-radius: 4px; border-left: 4px solid #2196F3; }
        .user-item.expired { border-left-color: #f44336; }
        .user-item.blocked { border-left-color: #FF9800; }
        
        .user-header { display: flex; justify-content: between; align-items: center; margin-bottom: 10px; }
        .user-info { flex: 1; }
        .user-actions { display: flex; gap: 10px; }
        .user-phone { font-size: 1.2em; font-weight: bold; }
        .user-details { color: #666; margin-top: 5px; }
        
        .status-badge { padding: 4px 8px; border-radius: 12px; font-size: 0.8em; font-weight: bold; }
        .status-active { background: #4CAF50; color: white; }
        .status-expired { background: #f44336; color: white; }
        .status-blocked { background: #FF9800; color: white; }
        
        .loading { text-align: center; padding: 40px; color: #666; }
    </style>
</head>
<body>
    <div class="container">
        <!-- 헤더 -->
        <div class="header">
            <h1>📱 Media Enhanced 관리자 대시보드</h1>
            <p>휴대폰 번호 기반 사용자 인증 및 관리 시스템</p>
            <div style="margin-top: 15px;">
                <a href="dashboard.html" style="color: white; margin-right: 20px; text-decoration: none;">🏠 대시보드</a>
                <a href="statistics.html" style="color: white; text-decoration: none;">📊 통계 센터</a>
            </div>
        </div>
        
        <!-- 통계 카드 -->
        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" id="totalUsers">-</div>
                <div>총 등록 사용자</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="activeUsers">-</div>
                <div>활성 사용자</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="expiredUsers">-</div>
                <div>만료된 사용자</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="blockedUsers">-</div>
                <div>차단된 사용자</div>
            </div>
        </div>
        
        <!-- 신규 등록 폼 -->
        <div class="section">
            <h3>📞 신규 사용자 등록</h3>
            <form id="registerForm">
                <div style="display: flex; gap: 20px;">
                    <div class="form-group" style="flex: 1;">
                        <label>휴대폰 번호</label>
                        <input type="tel" id="phoneNumber" placeholder="010-1234-5678" required 
                               pattern="010-\d{4}-\d{4}">
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label>등록 유형</label>
                        <select id="userType" onchange="updateCustomDays()">
                            <option value="trial3">🆓 무료체험 (3일)</option>
                            <option value="trial7">🔍 체험 (7일)</option>
                            <option value="month1">📅 1달 (30일)</option>
                            <option value="month3">📅 3달 (90일)</option>
                            <option value="month6">📅 6달 (180일)</option>
                            <option value="year1">📅 1년 (365일)</option>
                            <option value="custom">⚙️ 사용자 정의</option>
                        </select>
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label>사용자 정의 일수</label>
                        <input type="number" id="customDays" placeholder="직접 입력" disabled>
                        <small style="color: #666;">사용자 정의 선택 시 활성화</small>
                    </div>
                </div>
                <div class="form-group">
                    <label>메모 (선택)</label>
                    <input type="text" id="memo" placeholder="예: 강남 택시기사 김OO">
                </div>
                <button type="submit" class="btn btn-primary">📱 사용자 등록</button>
            </form>
        </div>
        
        <!-- 사용자 검색 및 필터 -->
        <div class="section">
            <h3>👥 등록된 사용자 관리</h3>
            <div style="display: flex; gap: 20px; margin-bottom: 20px;">
                <input type="text" id="searchInput" placeholder="휴대폰 번호 또는 메모 검색" style="flex: 1;">
                <select id="statusFilter">
                    <option value="">전체 상태</option>
                    <option value="active">활성</option>
                    <option value="blocked">차단</option>
                </select>
                <select id="typeFilter">
                    <option value="">전체 유형</option>
                    <option value="trial">체험</option>
                    <option value="premium">프리미엄</option>
                </select>
                <button class="btn btn-primary" onclick="loadUsers()">🔍 검색</button>
            </div>
            
            <!-- 사용자 목록 -->
            <div id="userList" class="loading">
                사용자 목록을 불러오는 중...
            </div>
        </div>
    </div>
    
    <script>
        // 관리자 비밀번호 (실제로는 더 안전한 방식 사용)
        const ADMIN_PASSWORD = 'your_secure_admin_password_here';
        
        // 페이지 로드 시 초기화
        document.addEventListener('DOMContentLoaded', () => {
            loadUsers();
            setInterval(loadUsers, 30000);  // 30초마다 자동 새로고침
        });
        
        // 등록 유형에 따른 일수 자동 설정
        function updateCustomDays() {
            const userType = document.getElementById('userType').value;
            const customDaysInput = document.getElementById('customDays');
            
            if (userType === 'custom') {
                customDaysInput.disabled = false;
                customDaysInput.placeholder = "직접 입력 (예: 45)";
                customDaysInput.focus();
            } else {
                customDaysInput.disabled = true;
                customDaysInput.value = '';
                customDaysInput.placeholder = "자동 설정됨";
            }
        }
        
        // 등록 유형별 일수 매핑
        function getDaysFromType(type) {
            const typeMap = {
                'trial3': 3,     // 무료체험
                'trial7': 7,     // 체험
                'month1': 30,    // 1달
                'month3': 90,    // 3달
                'month6': 180,   // 6달
                'year1': 365     // 1년
            };
            return typeMap[type] || null;
        }
        
        // 사용자 등록
        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const userType = document.getElementById('userType').value;
            const customDays = document.getElementById('customDays').value;
            
            // 일수 계산
            let days;
            if (userType === 'custom') {
                days = parseInt(customDays);
                if (!days || days <= 0) {
                    alert('❌ 사용자 정의 일수를 올바르게 입력해주세요.');
                    return;
                }
            } else {
                days = getDaysFromType(userType);
            }
            
            const data = {
                phone_number: document.getElementById('phoneNumber').value,
                type: userType,
                days: days,
                memo: document.getElementById('memo').value
            };
            
            try {
                const response = await fetch('/admin/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': ADMIN_PASSWORD
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('✅ 사용자가 등록되었습니다!');
                    document.getElementById('registerForm').reset();
                    loadUsers();
                } else {
                    alert('❌ 등록 실패: ' + result.message);
                }
            } catch (error) {
                alert('❌ 서버 연결 실패');
            }
        });
        
        // 사용자 목록 로드
        async function loadUsers() {
            try {
                const search = document.getElementById('searchInput')?.value || '';
                const status = document.getElementById('statusFilter')?.value || '';
                const type = document.getElementById('typeFilter')?.value || '';
                
                const params = new URLSearchParams({ search, status, type });
                
                const response = await fetch(`/admin/users?${params}`, {
                    headers: { 'Authorization': ADMIN_PASSWORD }
                });
                
                const data = await response.json();
                
                // 통계 업데이트
                document.getElementById('totalUsers').textContent = data.summary.total;
                document.getElementById('activeUsers').textContent = data.summary.active;
                document.getElementById('expiredUsers').textContent = data.summary.expired;
                document.getElementById('blockedUsers').textContent = data.summary.blocked;
                
                // 사용자 목록 렌더링
                renderUserList(data.users);
                
            } catch (error) {
                document.getElementById('userList').innerHTML = '❌ 데이터 로드 실패';
            }
        }
        
        // 등록 유형 표시명 매핑
        function getTypeDisplayName(type) {
            const typeNames = {
                'trial3': '🆓 무료체험',
                'trial7': '🔍 체험',
                'month1': '📅 1달',
                'month3': '📅 3달',
                'month6': '📅 6달',
                'year1': '📅 1년',
                'custom': '⚙️ 사용자정의'
            };
            return typeNames[type] || type;
        }
        
        // 사용자 목록 렌더링
        function renderUserList(users) {
            const userList = document.getElementById('userList');
            
            if (users.length === 0) {
                userList.innerHTML = '<div class="loading">등록된 사용자가 없습니다.</div>';
                return;
            }
            
            userList.innerHTML = users.map(user => {
                const statusClass = user.remaining_days <= 0 ? 'expired' : 
                                  user.status === 'blocked' ? 'blocked' : '';
                const statusText = user.status === 'blocked' ? '차단됨' :
                                 user.remaining_days <= 0 ? '만료됨' : '활성';
                const statusBadge = user.status === 'blocked' ? 'status-blocked' :
                                   user.remaining_days <= 0 ? 'status-expired' : 'status-active';
                
                // 유형별 아이콘
                const typeIcon = user.type.includes('trial') ? '🆓' : 
                               user.type.includes('year') ? '💎' : '📅';
                
                return `
                    <div class="user-item ${statusClass}">
                        <div class="user-header">
                            <div class="user-info">
                                <div class="user-phone">📱 ${user.phone_number}</div>
                                <div class="user-details">
                                    <span class="status-badge ${statusBadge}">${statusText}</span>
                                    ${typeIcon} ${getTypeDisplayName(user.type)} | 
                                    등록: ${user.registered_at} | 
                                    만료: ${user.expires_at} | 
                                    남은 기간: ${user.remaining_days}일
                                </div>
                                ${user.memo ? `<div style="margin-top: 5px; color: #888;">💬 ${user.memo}</div>` : ''}
                                ${user.last_auth ? `<div style="margin-top: 3px; font-size: 0.8em; color: #999;">마지막 접속: ${user.last_auth} (총 ${user.total_auths}회)</div>` : ''}
                            </div>
                            <div class="user-actions">
                                <button class="btn btn-success" onclick="extendUser('${user.id}')">⏰ 연장</button>
                                <button class="btn btn-danger" onclick="toggleBlock('${user.id}', ${user.status === 'active'})">${user.status === 'active' ? '🚫 차단' : '✅ 해제'}</button>
                                <button class="btn btn-danger" onclick="deleteUser('${user.id}')">🗑️ 삭제</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // 사용자 기간 연장
        async function extendUser(userId) {
            const days = prompt('연장할 일수를 입력하세요:', '30');
            if (!days || isNaN(days)) return;
            
            try {
                const response = await fetch('/admin/extend', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': ADMIN_PASSWORD
                    },
                    body: JSON.stringify({ user_id: userId, extend_days: parseInt(days) })
                });
                
                const result = await response.json();
                if (result.success) {
                    alert(`✅ ${days}일 연장되었습니다!`);
                    loadUsers();
                } else {
                    alert('❌ 연장 실패');
                }
            } catch (error) {
                alert('❌ 서버 연결 실패');
            }
        }
        
        // 사용자 차단/해제
        async function toggleBlock(userId, shouldBlock) {
            const action = shouldBlock ? '차단' : '차단해제';
            if (!confirm(`정말 ${action}하시겠습니까?`)) return;
            
            try {
                const response = await fetch('/admin/block', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': ADMIN_PASSWORD
                    },
                    body: JSON.stringify({ user_id: userId, block: shouldBlock })
                });
                
                const result = await response.json();
                if (result.success) {
                    alert(`✅ ${action}되었습니다!`);
                    loadUsers();
                } else {
                    alert(`❌ ${action} 실패`);
                }
            } catch (error) {
                alert('❌ 서버 연결 실패');
            }
        }
        
        // 사용자 삭제
        async function deleteUser(userId) {
            if (!confirm('정말 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.')) return;
            
            try {
                const response = await fetch(`/admin/user/${userId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': ADMIN_PASSWORD }
                });
                
                const result = await response.json();
                if (result.success) {
                    alert('✅ 사용자가 삭제되었습니다!');
                    loadUsers();
                } else {
                    alert('❌ 삭제 실패');
                }
            } catch (error) {
                alert('❌ 서버 연결 실패');
            }
        }
        
        // 검색 필터 적용
        document.getElementById('searchInput').addEventListener('input', () => {
            clearTimeout(window.searchTimeout);
            window.searchTimeout = setTimeout(loadUsers, 500);
        });
        
        document.getElementById('statusFilter').addEventListener('change', loadUsers);
        document.getElementById('typeFilter').addEventListener('change', loadUsers);
    </script>
</body>
</html>